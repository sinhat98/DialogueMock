from datetime import datetime
import json
from src.modules import templates
from src.utils import get_custom_logger
logger = get_custom_logger(__name__)

action_type_list = list(templates.get("scenes").keys())

today = datetime.now().strftime("%Y/%m/%d")


# today = datetime(2024, 10, 23).strftime("%Y/%m/%d")
def get_base_system_prompt(slot: dict):
    # 箇条書きリストに変換
    acttion_type_list_str = "\n".join(
        [f"- {action_type}" for action_type in action_type_list]
    )
    slot_str = "\n".join([f"- {slot_key}" for slot_key in slot.keys()])
    base_prompt = f"""
与えられたユーザーの要求から埋めるべきslotを**JSON**形式で抽出してください
日付はmm/dd形式で出力してください。今日は{today}です。
ただし、用件には以下のいずれかの値を埋めてください。
{acttion_type_list_str}

### slot
{slot_str}

### output_format
{json.dumps(slot, ensure_ascii=False)}
"""
    return base_prompt

# intentsは意図とフレーズのマッピング
def get_system_prompt_for_intent_classification(intents: dict):
    prompt = """
以下のフレーズに対応する意図を選択し、JSON形式で回答してください。

回答形式:
{
    "intent": "選択した意図"
}
"""
    logger.debug(f"intents: {intents}")
    phrases_str = "意図の種類と対応するフレーズ:"
    for intent, phrases in intents.items():
        phrases_str += f"\n- {intent}: {', '.join(phrases)}"
    phrases_str += "\n"
    
    tail_text = "回答は必ず" + ", ".join(intents.keys()) + "のいずれかをJSONのintentフィールドに設定してください。"
    
    prompt = f"{prompt}\n{phrases_str}\n{tail_text}"
    return prompt

# system_prompt_for_action_type = """
# 与えられたユーザーの要求から埋めるべきslotを**JSON**形式で抽出してください
# 日付はmm/dd形式で出力してください。今日は{today}です。
# ただし、用件には以下のいずれかの値を埋めてください。
# - 新規予約
# - 予約変更
# - 予約キャンセル
# - その他

# ### slot
# {slot}
# - 用件

# ### output_format

# """

system_prompt_for_slot_filling = """
与えられたユーザーの要求から埋めるべきslotを**JSON**形式で抽出してください
日付はmm/dd形式で出力してください。今日は{today}です。
予約変更の場合は変更するスロットも埋めて予約変更のスロットをtrueで埋めてください。

### slot

- 名前
- 日付
- 人数
- 時間

### output_format
{{"名前": "", "日付": "", "人数": "", "時間": ""}}
"""
system_prompt_for_slot_filling = system_prompt_for_slot_filling.format(today=today)

# 圧縮された新しいプロンプト
# system_prompt_for_faq = """
# あなたは飲食店の店員です。
# ユーザーからのメッセージに対して、以下のFAQリストを参照し、該当する質問に関連していれば、その質問に対応する回答を返してください。
# もし、関連する質問がない場合は、空文字を返してください。

# # FAQリスト:
# ## 基本的な質問
# 質問: 営業時間について
# 回答: 土日祝日ともに11:00から23:00まで営業しております。

# 質問: 駐車場の利用について
# 回答: 駐車場はございませんが、近隣にコインパーキングがございます。


# 質問: 同一グループでの異なるコース注文について
# 回答: 同一グループの方は、お席を分けても皆様同じコースをご注文いただきます。

# 質問: 個室の利用について
# 回答: 個室はございません。車いす・ベビーカー対応の席は一部店舗でご用意しております。ご利用の際は事前予約をお勧めいたします。

# 質問: グループでの飲み放題の注文について
# 回答: アルコールとソフトドリンクを組み合わせたご注文は可能です。ただし、グループの皆様がいずれかの飲み放題をご注文いただく必要があります。幼児様は、グループの皆様が飲み放題をご注文の場合、ソフトドリンク飲み放題を無料でご利用いただけます。

# 質問: 年齢確認や証明書について
# 回答: シニア料金、幼児・小学生料金ともに証明書は不要でございます。

# 質問: 各種支払い方法について
# 回答: ジェフグルメ券は全店でご使用可能です。その他のギフト券やキャッシュレス決済については、各店舗にお問い合わせください。また、全店がインボイス対象店舗となっております。

# 質問: 割引の併用について
# 回答: 株主優待券と割引券は併用可能です。シニア料金にも、特別な記載がない限り割引券をご利用いただけます。

# 質問: アレルギー情報について
# 回答: 最新のアレルギー情報はホームページでご確認いただけます。記載のない項目については、2週間程度の調査期間が必要となります。
# """

system_prompt_for_faq = """
あなたは焼肉店の店員です。
ユーザーからのメッセージに対して、以下のFAQリストを参照し、該当する質問に関連していれば、その質問に対応する回答を返してください。
もし、関連する質問がない場合は、空文字を返してください。

# FAQリスト:
## 基本情報
質問: 店舗の所在地を教えてください
回答: 渋谷の道玄坂にございます。道玄坂交差点を上がって右手、イチマルキューの向かい側のビルの3階です。

質問: アクセス方法を教えてください
回答: JR渋谷駅のハチ公口を出て、道玄坂方面へ徒歩3分です。イチマルキューの向かい側にある赤い看板が目印になります。

質問: 駐車場はありますか？
回答: 申し訳ございません。専用駐車場のご用意はございません。お近くのコインパーキングをご利用ください。

質問: 営業時間を教えてください
回答: 営業時間は午前11時から深夜0時までとなっております。ラストオーダーは23時30分です。

質問: 定休日はいつですか？
回答: 年中無休で営業しております。年末年始は営業時間が変更になる場合がございます。

## 店舗設備・収容人数
質問: 最大何名まで予約可能ですか？
回答: 最大で30名様までご予約いただけます。10名様以上の団体予約は、3日前までにご連絡をお願いしております。

質問: 席数・テーブル形態について教えてください
回答: テーブル席が12卓で48席、掘りごたつ式の座敷が2部屋で計12席ございます。

質問: 個室はありますか？
回答: 申し訳ございません。個室のご用意はございません。テーブル席と掘りごたつ式の座敷をご用意しております。

質問: 喫煙について教えてください
回答: 店内は全面禁煙となっております。喫煙所は建物1階に設置されております。

## メニュー・料金
質問: どのようなメニューがありますか？
回答: リーズナブルな大衆焼肉店として、カルビ、ロース、ホルモンなどの定番メニューを中心に、韓国料理やサイドメニューも豊富にご用意しております。おすすめは特選カルビと名物ユッケビビンバです。

質問: 予算の目安を教えてください
回答: お一人様の平均予算は、ランチタイムで1000円から1500円、ディナータイムで3000円から4000円です。飲み放題付きコースは、お一人様4000円からご用意しております。
"""

# もしユーザーの質問に該当するものがFAQリストにない場合は、'NOT_FOUND'を返してください。
# ただし、ユーザーの要求には音声認識誤りが含まれる可能性がある場合があります。音声認識誤りがあると思われる場合は、'APOLOGIZE'を返してください。



if __name__ == "__main__":
    intetns_dict = {
        "予約": ["予約したい", "予約を取りたい"],
        "キャンセル": ["予約をキャンセルしたい", "予約を取り消したい"],
        "変更": ["予約を変更したい", "予約を変更する"]
    }
    print(get_system_prompt_for_intent_classification(intetns_dict))